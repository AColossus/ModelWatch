<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dao.UserDao">
    <resultMap id="user" type="User">
        <id property="uId" column="u_id"></id>
        <result property="uUsername" column="u_username"></result>
        <result property="uAvater" column="u_avater"></result>
    </resultMap>

    <resultMap id="userInReply" type="User">
        <id property="uId" column="r_u_id"></id>
        <result property="uUsername" column="r_u_username"></result>
        <result property="uAvater" column="r_u_avater"></result>
    </resultMap>
    
    <select id="getUserStatic" resultType="User">
        select U_username,
        (select COUNT(*) from log where L_uid = U_id and L_pid=Inv_pid ) submit_num
        from user,invitation
        where U_id =Inv_uid and Inv_pid=#{pId} and Inv_state =1 union
        select U_username,
        (select COUNT(*) from log where L_uid = U_id and L_pid=P_id ) submit_num
        from user,project
        where U_id = P_Uid and P_id =#{pId}
        order by submit_num desc
    </select>

    <select id="selectUserByUid" resultType="User">
        select U_Id,U_username,U_avater,U_email,U_sex,U_birthday,U_signature,
        (select count(*) umn from model,user u where M_pid in (select P_id from project p where p.P_Uid=u.U_id)
        and u.u_id=#{uId} ) "uModelNum",
        (select count(*) upn from project p,user u
        where p.P_Uid=u.U_id and u.u_id=#{uId} ) "uProjectNum"
        from user where u_id=#{uId}
    </select>
    <select id="selectUserByUNAndPass" resultType="User">
        select U_Id,U_username,U_avater,U_email,U_sex,U_birthday,U_signature,
        (select count(*) umn from model,user u where M_pid in (select P_id from project p where p.P_Uid=u.U_id)
            and u.U_username=#{uUsername} and u.U_password=#{password}) "uModelNum",
        (select count(*) upn from project p,user u
            where p.P_Uid=u.U_id and U_username=#{uUsername} and U_password=#{password}) "uProjectNum"
        from user where U_username=#{uUsername} and U_password=#{password}
    </select>

    <select id="selectUsers" resultType="User">
        select * FROM User
    </select>

    <select id="selectUsersByContent" resultType="User">
        select * FROM User WHERE u_id=#{content} OR u_username LIKE '%' #{content} '%'
    </select>

    <update id="updateData">
        update user set U_username=#{uUsername},U_signature=#{uSignature},
            U_sex=#{uSex},U_email=#{uEmail},U_birthday=#{uBirthday}
            <if test="uAvater!=null">
                ,U_avater=#{uAvater}
            </if>
        where U_id=#{uId}
    </update>

    <update id="updatePassword">
        update user set U_password=#{uPassword} where U_id=#{uId}
    </update>

    <update id="updateState">
        update user set U_state=#{uState} where U_id=#{uId}
    </update>

    <insert id="addUser">
        insert ignore into user(U_username,U_password) values (#{uUsername},#{password})
    </insert>

    <select id="selectUname" resultType="User">
        select * FROM user WHERE U_username like concat(#{uName},'%')
    </select>

</mapper>