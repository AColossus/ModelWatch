<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dao.InvitationDao">
    <select id="selectInvitationByPid" resultType="User">
        select U_id,U_username,U_sex
        from user,invitation
        where invitation.Inv_pid=#{pid}
        and invitation.Inv_uid=user.U_id
    </select>
    <insert id="addInvitation">
        insert into invitation(Inv_pid,Inv_uid,Inv_state)
                values (#{pid},#{uid},1)
    </insert>
    <insert id="addInvByNamePid">
        insert into invitation (Inv_pid, Inv_uid,Inv_state)
        select #{pid},U_id,0
        from user
        where U_username=#{uUsername}
    </insert>

    <delete id="deleteInvitation">
        delete from invitation
        where Inv_pid=#{pid}
        and Inv_uid=#{uid}
    </delete>

    <select id="selectCollaboratorsByPidPage" resultType="User">
        select u.U_id,u.U_avater,u.U_birthday,u.U_email,u.U_signature,u.U_username,
            Inv_Time,Inv_state
        from user u,invitation i
        where u.U_id = i.Inv_uid AND  i.Inv_pid=#{pid}
        order by i.Inv_Time desc
    </select>

    <update id="alterInvState">
        UPDATE invitation SET Inv_state = 1 WHERE Inv_pid=#{pId} and Inv_uid=(select U_id from user where U_username=#{uName})
    </update>

    <delete id="deleteWaitItem">
        delete from invitation where Inv_pid=#{pId} and Inv_uid=(select U_id from user where U_username=#{uName}) and Inv_State=0
    </delete>

    <select id="findMessage" resultType="Invitation">
        select
            p.U_username "manager.uUsername",
            u.U_avater "collaborator.uAvater",
            p.P_name "project.pName",
            p.U_avater "manager.uAvater"
        from invitation i,user u,
            (select pj.P_id,P_name,mr.U_avater,mr.U_username from project pj,user mr where pj.P_Uid = mr.U_id) p
        where p.P_id=#{pId} and u.U_username =#{myName} and i.Inv_pid = p.P_id and i.Inv_uid = u.u_id
    </select>

    <select id="getMailByName" resultType="User">
        select * from user WHERE U_username=#{myName}
    </select>

    <select id="getUserName" resultType="User">
        select u.U_username from user u,project p where u.U_id=p.P_Uid and p.P_id=#{pId}
    </select>
</mapper>